<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="stacks">
<title>Stacking With Workflow Sets • stacks</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Stacking With Workflow Sets">
<meta property="og:description" content="stacks">
<meta property="og:image" content="https://stacks.tidymodels.org/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="stacks.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">stacks</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.0.4.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/basics.html">Getting Started With stacks</a>
    <a class="dropdown-item" href="../articles/classification.html">Classification Models With stacks</a>
    <a class="dropdown-item" href="../articles/workflowsets.html">Stacking With Workflow Sets</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tidymodels/stacks/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Stacking With Workflow Sets</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/stacks/blob/HEAD/vignettes/articles/workflowsets.Rmd" class="external-link"><code>vignettes/articles/workflowsets.Rmd</code></a></small>
      <div class="d-none name"><code>workflowsets.Rmd</code></div>
    </div>

    
    
<p>The stacks package provides a shorthand interface for supplying
multiple sets of candidate members in one call to
<code><a href="../reference/add_candidates.html">add_candidates()</a></code> via the <a href="https://workflowsets.tidymodels.org/" class="external-link">workflowsets</a> package.
Instead of iteratively calling <code><a href="../reference/add_candidates.html">add_candidates()</a></code> for each
tuning result:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">tuning_result_1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">tuning_result_2</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">tuning_result_3</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">tuning_result_4</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fit_members.html">fit_members</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>…we can add candidate members “in batch:”</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">wf_set</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fit_members.html">fit_members</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This interface is especially helpful with a large number of candidate
members, which is exactly the setting that model stacking excels in.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>This example will parallel <a href="https://stacks.tidymodels.org/articles/basics.html">the “Getting
Started” vignette</a>, except that we will use workflowsets to bundle
the model workflows that define the candidate members into one workflow
set. We will then train each of them using <a href="https://workflowsets.tidymodels.org/reference/workflow_map.html" class="external-link">workflowsets::workflow_map()</a>
and add the results to a model stack using
<code><a href="../reference/add_candidates.html">add_candidates()</a></code>. If you’re not familiar with the stacks
package, refer to that vignette for the big picture!</p>
<p>First, loading needed packages:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stacks.tidymodels.org/">stacks</a></span><span class="op">)</span></span></code></pre></div>
<p>In this example, we’ll again make use of the <code>tree_frogs</code>
data exported with <code>stacks</code>, giving experimental results on
hatching behavior of red-eyed tree frog embryos!</p>
<p>Red-eyed tree frog (RETF) embryos can hatch earlier than their normal
7ish days if they detect potential predator threat. Researchers wanted
to determine how, and when, these tree frog embryos were able to detect
stimulus from their environment. To do so, they subjected the embryos at
varying developmental stages to “predator stimulus” by jiggling the
embryos with a blunt probe. Beforehand, though some of the embryos were
treated with gentamicin, a compound that knocks out their lateral line
(a sensory organ.) Researcher Julie Jung and her crew found that these
factors inform whether an embryo hatches prematurely or not!</p>
<p>We’ll start out with predicting <code>latency</code> (i.e. time to
hatch) based on other attributes. We’ll need to filter out NAs
(i.e. cases where the embryo did not hatch) first.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"tree_frogs"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># subset the data</span></span>
<span><span class="va">tree_frogs</span> <span class="op">&lt;-</span> <span class="va">tree_frogs</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">latency</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">clutch</span>, <span class="va">hatched</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Taking a quick look at the data, it seems like the hatch time is
pretty closely related to some of our predictors!</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">tree_frogs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">latency</span>, color <span class="op">=</span> <span class="va">treatment</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Embryo Age (s)"</span>, y <span class="op">=</span> <span class="st">"Time to Hatch (s)"</span>, col <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflowsets_files/figure-html/unnamed-chunk-5-1.png" alt="A ggplot scatterplot with embryo age in seconds on the x axis, time to hatch on the y axis, and points colored by treatment. The ages range from 350,000 to 500,000 seconds, while the times to hatch range from 0 to 450 seconds. There are two treatments—control and gentamicin—and the time to hatch is generally larger for the gentamicin group. The embryo ages are generally distributed in three clouds, where the older embryos tend to hatch more quickly after stimulus than the younger ones." width="768"></p>
<p>Let’s give this a go!</p>
</div>
<div class="section level2">
<h2 id="defining-candidate-ensemble-members">Defining candidate ensemble members<a class="anchor" aria-label="anchor" href="#defining-candidate-ensemble-members"></a>
</h2>
<p>As in the workflow-based setting, defining the candidate ensemble
members is undoubtedly the longest part of the ensembling process with
stacks. Instead of evaluating our model specifications via resampling
for each workflow, though, we combine each of the model specifications
with <code><a href="https://workflowsets.tidymodels.org/reference/workflow_set.html" class="external-link">workflow_set()</a></code>, and then evaluate them in batch with
the <code><a href="https://workflowsets.tidymodels.org/reference/workflow_map.html" class="external-link">workflow_map()</a></code> function.</p>
<p>First, splitting up the training data, generating resamples, and
setting some options that will be used by each model definition:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># some setup: resampling and a basic recipe</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">tree_frogs_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">initial_split</a></span><span class="op">(</span><span class="va">tree_frogs</span><span class="op">)</span></span>
<span><span class="va">tree_frogs_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">training</a></span><span class="op">(</span><span class="va">tree_frogs_split</span><span class="op">)</span></span>
<span><span class="va">tree_frogs_test</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rsample.tidymodels.org/reference/initial_split.html" class="external-link">testing</a></span><span class="op">(</span><span class="va">tree_frogs_split</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu">rsample</span><span class="fu">::</span><span class="fu"><a href="https://rsample.tidymodels.org/reference/vfold_cv.html" class="external-link">vfold_cv</a></span><span class="op">(</span><span class="va">tree_frogs_train</span>, v <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_frogs_rec</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/recipe.html" class="external-link">recipe</a></span><span class="op">(</span><span class="va">latency</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">tree_frogs_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metric</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html" class="external-link">metric_set</a></span><span class="op">(</span><span class="va">rmse</span><span class="op">)</span></span></code></pre></div>
<p>We also need to use the same control settings as in the
workflow-based setting:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctrl_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/control_stack.html">control_stack_grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We’ll define three different model definitions to try to predict time
to hatch—a K-nearest neighbors model (with hyperparameters to tune), a
linear model, and a support vector machine model (again, with
hyperparameters to tune).</p>
<p>Starting out with K-nearest neighbors, we begin by creating a parsnip
model specification:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a model specification</span></span>
<span><span class="va">knn_spec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/nearest_neighbor.html" class="external-link">nearest_neighbor</a></span><span class="op">(</span></span>
<span>    mode <span class="op">=</span> <span class="st">"regression"</span>, </span>
<span>    neighbors <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="st">"k"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"kknn"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knn_spec</span></span>
<span><span class="co">#&gt; K-Nearest Neighbor Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   neighbors = tune("k")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: kknn</span></span></code></pre></div>
<p>Note that, since we are tuning over several possible numbers of
neighbors, this model specification defines multiple model
configurations. The specific form of those configurations will be
determined when specifying the grid search.</p>
<p>From here, we extend the basic recipe defined earlier to fully
specify the form of the design matrix for use in a K-nearest neighbors
model:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># extend the recipe</span></span>
<span><span class="va">knn_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tree_frogs_rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html" class="external-link">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_mean.html" class="external-link">step_impute_mean</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">knn_rec</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Recipe</span> <span style="color: #00BBBB;">────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Inputs</span></span>
<span><span class="co">#&gt; Number of variables by role</span></span>
<span><span class="co">#&gt; outcome:   1</span></span>
<span><span class="co">#&gt; predictor: 4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Operations</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Dummy variables from: <span style="color: #0000BB;">all_nominal_predictors()</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Zero variance filter on: <span style="color: #0000BB;">all_predictors()</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Mean imputation for: <span style="color: #0000BB;">all_numeric_predictors()</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Centering and scaling for: <span style="color: #0000BB;">all_numeric_predictors()</span></span></span></code></pre></div>
<p>Starting with the basic recipe, we convert categorical predictors to
dummy variables, remove predictors with only one observation, impute
missing values in numeric predictors using the mean, and normalize
numeric predictors. Pre-processing instructions for the remaining models
are defined similarly.</p>
<p>Now, specifying the linear model, note that we are not optimizing
over any hyperparameters.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a model specification</span></span>
<span><span class="va">lin_reg_spec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"lm"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extend the recipe</span></span>
<span><span class="va">lin_reg_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tree_frogs_rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html" class="external-link">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Finally, putting together the model specification and recipe for the
support vector machine:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a model specification</span></span>
<span><span class="va">svm_spec</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/svm_rbf.html" class="external-link">svm_rbf</a></span><span class="op">(</span></span>
<span>    cost <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span>, </span>
<span>    rbf_sigma <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="st">"sigma"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"kernlab"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html" class="external-link">set_mode</a></span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># extend the recipe</span></span>
<span><span class="va">svm_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">tree_frogs_rec</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_dummy.html" class="external-link">step_dummy</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_nominal_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_zv.html" class="external-link">step_zv</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_impute_mean.html" class="external-link">step_impute_mean</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_corr.html" class="external-link">step_corr</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://recipes.tidymodels.org/reference/step_normalize.html" class="external-link">step_normalize</a></span><span class="op">(</span><span class="fu"><a href="https://recipes.tidymodels.org/reference/has_role.html" class="external-link">all_numeric_predictors</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With each model specification and accompanying recipe now defined, we
can combine them via <code>workflow_set</code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf_set</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://workflowsets.tidymodels.org/reference/workflow_set.html" class="external-link">workflow_set</a></span><span class="op">(</span></span>
<span>    preproc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>rec1 <span class="op">=</span> <span class="va">knn_rec</span>, rec2 <span class="op">=</span> <span class="va">lin_reg_rec</span>,     rec3 <span class="op">=</span> <span class="va">svm_rec</span><span class="op">)</span>,</span>
<span>    models <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knn <span class="op">=</span> <span class="va">knn_spec</span>, lin_reg <span class="op">=</span> <span class="va">lin_reg_spec</span>, svm <span class="op">=</span> <span class="va">svm_spec</span><span class="op">)</span>,</span>
<span>    cross <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">wf_set</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A workflow set/tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   wflow_id     info             option    result    </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rec1_knn     <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[0]&gt;</span> <span style="color: #949494;">&lt;list [0]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rec2_lin_reg <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[0]&gt;</span> <span style="color: #949494;">&lt;list [0]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> rec3_svm     <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[0]&gt;</span> <span style="color: #949494;">&lt;list [0]&gt;</span></span></span></code></pre></div>
<p>Note that each combination of preprocessor and model specification is
assigned a <code>wflow_id</code> that we can use to interface with
individual model definitions:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf_set</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_workflow</a></span><span class="op">(</span><span class="st">"rec3_svm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; ══ Workflow ══════════════════════════════════════════════════════════════</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Preprocessor:</span> Recipe</span></span>
<span><span class="co">#&gt; <span style="font-style: italic;">Model:</span> svm_rbf()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Preprocessor ──────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; 5 Recipe Steps</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; • step_dummy()</span></span>
<span><span class="co">#&gt; • step_zv()</span></span>
<span><span class="co">#&gt; • step_impute_mean()</span></span>
<span><span class="co">#&gt; • step_corr()</span></span>
<span><span class="co">#&gt; • step_normalize()</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Model ─────────────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Radial Basis Function Support Vector Machine Model Specification (regression)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Main Arguments:</span></span>
<span><span class="co">#&gt;   cost = tune("cost")</span></span>
<span><span class="co">#&gt;   rbf_sigma = tune("sigma")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Computational engine: kernlab</span></span></code></pre></div>
<p>The elements in this workflow set are nearly ready to be evaluated
with <code><a href="https://tune.tidymodels.org/reference/tune_grid.html" class="external-link">tune_grid()</a></code>. Before we do so, though, we need to
ensure that we fit each with the appropriate control options, just as we
do when evaluating individual workflows on resamples before passing them
to stacks.</p>
<p>We can iteratively add the appropriate control settings with the
<code><a href="../reference/control_stack.html">control_stack_grid()</a></code> shorthand using the
<code><a href="https://workflowsets.tidymodels.org/reference/option_add.html" class="external-link">option_add()</a></code> function:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf_set</span> <span class="op">&lt;-</span></span>
<span>  <span class="va">wf_set</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://workflowsets.tidymodels.org/reference/option_add.html" class="external-link">option_add</a></span><span class="op">(</span></span>
<span>    control <span class="op">=</span> <span class="fu"><a href="../reference/control_stack.html">control_stack_grid</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    metrics <span class="op">=</span> <span class="va">metric</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can now use the <code><a href="https://workflowsets.tidymodels.org/reference/workflow_map.html" class="external-link">workflow_map()</a></code> function to map over
each model definition, evaluating hyperparameters on the supplied
resamples.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wf_set_trained</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://workflowsets.tidymodels.org/reference/workflow_map.html" class="external-link">workflow_map</a></span><span class="op">(</span></span>
<span>    <span class="va">wf_set</span>,</span>
<span>    fn <span class="op">=</span> <span class="st">"tune_grid"</span>,</span>
<span>    resamples <span class="op">=</span> <span class="va">folds</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">wf_set_trained</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A workflow set/tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   wflow_id     info             option    result   </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rec1_knn     <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[3]&gt;</span> <span style="color: #949494;">&lt;tune[+]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rec2_lin_reg <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[3]&gt;</span> <span style="color: #949494;">&lt;rsmp[+]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> rec3_svm     <span style="color: #949494;">&lt;tibble [1 × 4]&gt;</span> <span style="color: #949494;">&lt;opts[3]&gt;</span> <span style="color: #949494;">&lt;tune[+]&gt;</span></span></span></code></pre></div>
<p>The results section now contains three sets of tuning results. Note
that the results corresponding to the linear regression have the
subclass <code>resample_results</code> rather than
<code>tune_results</code>—this is expected, as there were no
hyperparameters to tune for that model specification.
<code><a href="https://workflowsets.tidymodels.org/reference/workflow_map.html" class="external-link">workflow_map()</a></code> knows to fall back to
<code><a href="https://tune.tidymodels.org/reference/fit_resamples.html" class="external-link">fit_resamples()</a></code> rather than <code><a href="https://tune.tidymodels.org/reference/tune_grid.html" class="external-link">tune_grid()</a></code>, in
this case!</p>
<p>We can extract tuning results with the
<code><a href="https://workflowsets.tidymodels.org/reference/extract_workflow_set_result.html" class="external-link">extract_workflow_set_result()</a></code> helper to explore our tuning
results:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://workflowsets.tidymodels.org/reference/extract_workflow_set_result.html" class="external-link">extract_workflow_set_result</a></span><span class="op">(</span><span class="va">wf_set_trained</span>, id <span class="op">=</span> <span class="st">"rec1_knn"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html" class="external-link">collect_metrics</a></span><span class="op">(</span>summarize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 7</span></span></span>
<span><span class="co">#&gt;        k .metric .estimator  mean     n std_err .config              </span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     1 rmse    standard    81.3     5    4.37 Preprocessor1_Model01</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     3 rmse    standard    69.6     5    3.57 Preprocessor1_Model02</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     5 rmse    standard    63.7     5    3.30 Preprocessor1_Model03</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     6 rmse    standard    62.3     5    3.12 Preprocessor1_Model04</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     7 rmse    standard    61.2     5    2.95 Preprocessor1_Model05</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     9 rmse    standard    59.8     5    2.82 Preprocessor1_Model06</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    10 rmse    standard    59.3     5    2.83 Preprocessor1_Model07</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    11 rmse    standard    59.0     5    2.82 Preprocessor1_Model08</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    13 rmse    standard    58.5     5    2.84 Preprocessor1_Model09</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    15 rmse    standard    58.2     5    2.88 Preprocessor1_Model10</span></span></code></pre></div>
<p>With these three model definitions fully specified and tuned in a
workflow set, we are ready to begin stacking these model configurations.
(Note that, in most applied settings, one would likely specify many more
than a handful candidate members from three model definitions.)</p>
</div>
<div class="section level2">
<h2 id="putting-together-a-stack">Putting together a stack<a class="anchor" aria-label="anchor" href="#putting-together-a-stack"></a>
</h2>
<p>Building the stacked ensemble, now, takes even fewer lines than it
did with individual workflows:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_frogs_model_st</span> <span class="op">&lt;-</span> </span>
<span>  <span class="co"># initialize the stack</span></span>
<span>  <span class="fu"><a href="../reference/stacks.html">stacks</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># add candidate members</span></span>
<span>  <span class="fu"><a href="../reference/add_candidates.html">add_candidates</a></span><span class="op">(</span><span class="va">wf_set_trained</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># determine how to combine their predictions</span></span>
<span>  <span class="fu"><a href="../reference/blend_predictions.html">blend_predictions</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># fit the candidates with nonzero stacking coefficients</span></span>
<span>  <span class="fu"><a href="../reference/fit_members.html">fit_members</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_frogs_model_st</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   member           type             weight</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> rec3_svm_1_06    svm_rbf          0.779 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> rec2_lin_reg_1_1 linear_reg       0.275 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> rec1_knn_1_08    nearest_neighbor 0.190 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> rec1_knn_1_07    nearest_neighbor 0.020<span style="text-decoration: underline;">5</span></span></span></code></pre></div>
<p>The results obtained from building a model stack with workflow sets
are identical to those that would result from building a model stack
with individual workflows.</p>
<p>To make sure that we have the right trade-off between minimizing the
number of members and optimizing performance, we can use:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflowsets_files/figure-html/penalty-plot-1.png" alt="A ggplot line plot. The x axis shows the degree of penalization, ranging from 1e-06 to 1e-01, and the y axis displays the mean of three different metrics. The plots are faceted by metric type, with three facets: number of members, root mean squared error, and R squared. The plots generally show that, as penalization increases, the error decreases. There are very few proposed members in this example, so penalization doesn't drive down the number of members much at all. In this case, then, a larger penalty is acceptable." width="768"></p>
<p>If these results were not good enough,
<code><a href="../reference/blend_predictions.html">blend_predictions()</a></code> could be called again with different
values of <code>penalty</code>. As it is,
<code><a href="../reference/blend_predictions.html">blend_predictions()</a></code> picks the penalty parameter with the
numerically optimal results. To see the top results:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, type <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflowsets_files/figure-html/weight-plot-1.png" alt="A ggplot bar plot, giving the stacking coefficient on the x axis and member on the y axis. There are three members in this ensemble, where a nearest neighbor is weighted most heavily, followed by a linear regression with a stacking coefficient about half as large, followed by a support vector machine with a very small contribution." width="768"></p>
<p>To identify which model configurations were assigned what stacking
coefficients, we can make use of the <code><a href="../reference/collect_parameters.html">collect_parameters()</a></code>
function:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/collect_parameters.html">collect_parameters</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, <span class="st">"rec3_svm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 4</span></span></span>
<span><span class="co">#&gt;    member            cost    sigma  coef</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> rec3_svm_1_01  0.185   1.17<span style="color: #949494;">e</span><span style="color: #BB0000;">- 4</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> rec3_svm_1_02  1.23    2.39<span style="color: #949494;">e</span><span style="color: #BB0000;">- 7</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> rec3_svm_1_03  0.019<span style="text-decoration: underline;">5</span>  3.37<span style="color: #949494;">e</span><span style="color: #BB0000;">- 5</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> rec3_svm_1_04 15.2     4.78<span style="color: #949494;">e</span><span style="color: #BB0000;">- 8</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> rec3_svm_1_05  2.97    1.30<span style="color: #949494;">e</span><span style="color: #BB0000;">- 6</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> rec3_svm_1_06  0.134   5.62<span style="color: #949494;">e</span><span style="color: #BB0000;">- 2</span> 0.779</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> rec3_svm_1_07  0.001<span style="text-decoration: underline;">63</span> 3.01<span style="color: #949494;">e</span><span style="color: #BB0000;">- 3</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> rec3_svm_1_08  4.08    2.98<span style="color: #949494;">e</span><span style="color: #BB0000;">- 1</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> rec3_svm_1_09  0.004<span style="text-decoration: underline;">29</span> 3.45<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span> 0    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> rec3_svm_1_10  0.028<span style="text-decoration: underline;">0</span>  1.54<span style="color: #949494;">e</span><span style="color: #BB0000;">- 9</span> 0</span></span></code></pre></div>
<p>This object is now ready to predict with new data!</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_frogs_test</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tree_frogs_test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Juxtaposing the predictions with the true data:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ggplot</span><span class="op">(</span><span class="va">tree_frogs_test</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">latency</span>, </span>
<span>      y <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://tune.tidymodels.org/reference/coord_obs_pred.html" class="external-link">coord_obs_pred</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="workflowsets_files/figure-html/unnamed-chunk-20-1.png" alt="A ggplot scatterplot showing observed versus predicted latency values. While there is indeed a positive and roughly linear relationship, there is certainly patterned structure in the residuals." width="768"></p>
<p>Looks like our predictions were decent! How do the stacks predictions
perform, though, as compared to the members’ predictions? We can use the
<code>type = "members"</code> argument to generate predictions from each
of the ensemble members.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">member_preds</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">tree_frogs_test</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">latency</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html" class="external-link">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">tree_frogs_model_st</span>, <span class="va">tree_frogs_test</span>, members <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, evaluating the root mean squared error from each model:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">map</span><span class="op">(</span><span class="va">member_preds</span>, <span class="va">rmse_vec</span>, truth <span class="op">=</span> <span class="va">member_preds</span><span class="op">$</span><span class="va">latency</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 6</span></span></span>
<span><span class="co">#&gt;   latency .pred rec1_knn_1_07 rec1_knn_1_08 rec2_lin_reg_1_1 rec3_svm_1_06</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       0  53.9          56.2          56.2             55.5          57.3</span></span></code></pre></div>
<p>As we can see, the stacked ensemble outperforms each of the member
models, though is closely followed by one of its members.</p>
<p>Voila! You’ve now made use of the stacks and workflowsets packages to
predict red-eyed tree frog embryo hatching using a stacked ensemble!</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Simon Couch, <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
